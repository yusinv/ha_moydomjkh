# home_assistant компоненты для работы с порталом Мой Дом (https://newlk.erconline.ru/)

1. Клонировать репозиторий [https://github.com/yusinv/ha_moydomjkh.git](https://github.com/yusinv/ha_moydomjkh.git)
2. Создать при необходимости папку "custom_components" и в нее скопировать папку "moydomjkh" и ее содержимое.
3. Добавить новую интеграцию Moy Dom JKH HA integration через интерфейс. 
4. Компонент автоматически добавит сенсоры 
   * по одному на каждый лицевой счет (для отоброжения задолжности/переплаты)
   * по одному на каждый счетчик (отобржает значения счетчика). 
   
   Название сенсора можно переименовать в Home_assistant (HASS). Счетчики можно так же отключить (в настройках HASS). Автоматическое обновление данных с портала происходит раз в день. 
5. Для передачи показаний нужно вызвать сервис **moydomjkh.submit_utility_usage** со следующими параметрами:
   
            meter: ID счетчика
            value: число (если нужно установить конкретное число)
            delta_value: число (если нужно увеличить текущее значение на переданное число)
   По результатам выполнения сервис сгенериует одно из двух событий (event):
   * В случае, если сервис отработал успешно, будет сгенерировано событие **submit_utility_usage_success**, которое будет содержать json следующего формата: {value: новое значение счетчика}
   * В случае, если сервис отработал с ошибкой, будет сгенерировано событие **submit_utility_usage_fail**, которое будет содержать json следующего формата: {msg:строка с ошибкой}
6. Что бы сгенерировать ссылку на оплату нужно вызвать сервис **moydomjkh.generate_payment_url** со следующими параметрами:
   
            account: ID аккаунта (Лицевого Счета)
            amount: сумма (необязательно, если оставить пустым то подставится текущаяя задолжность)
   По результатам выполнения сервис сгенериует одно из двух событий (event):
   * В случае, если сервис отработал успешно, будет сгенерировано событие **generate_payment_url_success**, которое будет содержать json следующего формата: {url: сгенеренный урл}
   * В случае, если сервис отработал с ошибкой, будет сгенерировано событие **generate_payment_url_failed**, которое будет содержать json следующего формата: {msg:строка с ошибкой}
